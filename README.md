***

ts-node ./src/cli/generate-random-keypairs.ts --count 1

[2025-07-28T10:46:00.582Z] [
        {
                "publicKey": "0xaf6644ddd084ac99ffbc0f3e233694cf4356c4106709913210413779d17e8486",
                "privateKey": "0x88eab7fda0159b008a2f3636c88b8af0196fc2fc9a34bbb1b63c1958488223ce"
        }
]

***

ts-node ./src/cli/deploy.ts --deployerPublicKey af6644ddd084ac99ffbc0f3e233694cf4356c4106709913210413779d17e8486 --mock-proof --transmit &> deploy.log

[2025-07-28T10:48:33.823Z] App ID: 3b0ad31236878d16961cdd16f99c37b048943747c09a4a9eed97c9592a25fb87
[2025-07-28T10:48:37.051Z] App Verification Key: ead64b28a5854f4be43637305362f33b32fa533ebd21cc2cda96840450f42151
[2025-07-28T10:49:17.318Z] Spell transmitted successfully: [
  "38f02936e121cd854fcbbf0a6236c22c61dc1f56c5002c7c77dd318daa6fa20e",
  "961a2734d3b9bcd0049b15dbf8c5f11fa6623d4cd0bd3f2ed2b6e237b1c4fdd3"
]

***

ts-node ./src/cli/user-payment.ts --current-public-keys af6644ddd084ac99ffbc0f3e233694cf4356c4106709913210413779d17e8486 --current-threshold 1 --amount 666666 &> user-payment.log

[2025-07-28T10:53:18.843Z] Recovery keypair generated: {
  "publicKey": "0x213c1539be1fb847318ab399053cd89f10ad449bdffa3969e72b275d1e2b811f",
  "privateKey": "0x24eee63154ab7934ea272ca72edb966e649bdcdc62d5525c94477eefd4f3b37a"
}
[2025-07-28T10:53:18.883Z] Sending funds to user payment address: bcrt1p4dj20vtz4l7wxgj738pyalrvt0440d33v0zta43yzjnjrjuy0dyq6yjdsp
[2025-07-28T10:53:18.917Z] Funds sent successfully, txid:  01c59201c89cd07137b5f510d60286c4a23893b0153581d39cf0ccfa7c59c390
[2025-07-28T10:53:18.917Z] Recovery public key: 213c1539be1fb847318ab399053cd89f10ad449bdffa3969e72b275d1e2b811f

***

ts-node ./src/cli/pegin.ts --app-id 3b0ad31236878d16961cdd16f99c37b048943747c09a4a9eed97c9592a25fb87 --app-vk ead64b28a5854f4be43637305362f33b32fa533ebd21cc2cda96840450f42151 --new-public-keys af6644ddd084ac99ffbc0f3e233694cf4356c4106709913210413779d17e8486 --new-threshold 1 --previous-nft-txid 961a2734d3b9bcd0049b15dbf8c5f11fa6623d4cd0bd3f2ed2b6e237b1c4fdd3 --recovery-public-key 213c1539be1fb847318ab399053cd89f10ad449bdffa3969e72b275d1e2b811f --private-keys 88eab7fda0159b008a2f3636c88b8af0196fc2fc9a34bbb1b63c1958488223ce --user-payment-txid 01c59201c89cd07137b5f510d60286c4a23893b0153581d39cf0ccfa7c59c390 --mock-proof --transmit &> pegin.log

[2025-07-28T11:02:10.719Z] Spell transmitted successfully: [
  "dec430075feddbc98388d5a9d8acfd87c7ba660c334a861711aab759789b534f",
  "acbe668971eac0865ce28c026af649a954beddbbe80c09dd2714bfc65a85d41c"
]

***

# How to Run E2E Tests

## Prerequisites

- Bitcoin Core with regtest configuration
- Charms CLI tool installed from [bitsnark/charms](https://github.com/bitsnark/charms) (stable version)


## Environment Setup

Set the following environment variables:

```bash
export BTC_WALLET_NAME=testwallet
export CHARMS_BIN=~/.cargo/bin/charms
```

## Bitcoin Regtest Node Configuration

### 1. Bitcoin Configuration File

Create or update your `bitcoin.conf` file with the following settings:

```ini
server=1
txindex=1

daemon=0
addresstype=bech32m
changetype=bech32m

rpcport=18443
# Enable regtest mode
regtest=1

# RPC authentication
rpcuser=bitcoin
rpcpassword=1234

# Allow RPC connections only from localhost
rpcallowip=127.0.0.1

# Optional: Enable timestamps in logs
logtimestamps=1

# Optional: Enable debugging logs
debug=1
```

### 2. Bitcoin Node Setup

Start the Bitcoin regtest node and perform initial setup:

```bash
# Start bitcoind
bitcoind

# Create wallet
b createwallet testwallet

# Unload wallet (if needed)
b loadwallet "testwallet"

# Generate new address
b getnewaddress
# Example output: bcrt1pyezp8aenr3d779g6hg7z8jhjmrdwuvw3lnt9a2gdlec72hrkfpxqqx6m5p

# Generate 101 blocks to the address (for coinbase maturity)
b generatetoaddress 101 bcrt1pyezp8aenr3d779g6hg7z8jhjmrdwuvw3lnt9a2gdlec72hrkfpxqqx6m5p

# List unspent transactions
b listunspent
```


# Running the Tests

```bash
$ npm run test

> grail-pro-charms@1.0.1 test
> jest --detectOpenHandles --testPathIgnorePatterns=integration

  console.log
    Deployer Public Key: ad72650736462b7943bdec97f9bdfb7694a7d702ee328c33b51f3530cf67bbd2

      at Object.<anonymous> (tests/simple-e2e.test.ts:13:13)

  console.log
    Deployer Private Key: cb65afd67a964bbd6a79a3d71653505c7a5cff0f5a74c265ea216a0cdab78a36

      at Object.<anonymous> (tests/simple-e2e.test.ts:14:13)

[2025-07-28T20:30:52.279Z] App ID: 5002d45009bd627e028546310856f5b05e5ff5672368137b363b74d5f6e2784f
  console.warn
    App VK is not provided, using charms app vk command to retrieve it

      48 |
      49 |              if (!obj.appVk) {
    > 50 |                      console.warn(
         |                              ^
      51 |                              'App VK is not provided, using charms app vk command to retrieve it'
      52 |                      );
      53 |                      thus.appVk = await getVerificationKey(thus);

      at Function.create (src/core/context.ts:50:12)
      at Function.createForDeploy (src/core/context.ts:78:18)
      at deployNftCli (src/cli/deploy.ts:115:32)
      at async Object.<anonymous> (tests/simple-e2e.test.ts:16:20)

  console.info
    Executing command: /home/elmol/.cargo/bin/charms app vk

      at src/core/charms-sdk.ts:16:11

[2025-07-28T20:30:55.903Z] Error:
  console.error
    Stderr: [sp1]      Finished `release` profile [optimized] target(s) in 0.04s
    cargo:rustc-env=SP1_ELF_grail-pro-charms=/home/elmol/Documents/wakeup/bitsnark/grail-pro/repo/backend/grail-pro-charms/zkapp/target/elf-compilation/riscv32im-succinct-zkvm-elf/release/grail-pro-charms
    detected old compiler flags: recompile the ELF for additional security
    

      18 |      console.error = function (...args: any[]) {
      19 |              console.log('Error:');
    > 20 |              originalConsoleError(...args);
         |              ^
      21 |      };
      22 | }
      23 |

      at console.error (src/core/log.ts:20:3)
      at src/core/charms-sdk.ts:32:14

  console.info
    Executed successfully: c2eeda47cde8845126f2751c9eaedb50b29f154b49b52456dd32d7204e2b0f1f

      at src/core/charms-sdk.ts:34:13

[2025-07-28T20:30:55.906Z] App Verification Key: c2eeda47cde8845126f2751c9eaedb50b29f154b49b52456dd32d7204e2b0f1f
[2025-07-28T20:30:56.018Z] Creating spell...
  console.info
    Executing command: /home/elmol/.cargo/bin/charms spell prove --spell /tmp/charms-cSiWKC/spell.yaml --fee-rate 2000 --app-bins ./zkapp/target/charms-app --funding-utxo a4dea9ae1030a9cc029f151fa1abb1af5a50f195e66410fb74cf0011a1ac7e7e:0 --funding-utxo-value 5000000000 --change-address bcrt1pm8j6yrn356w60y0gf5lm4yaqx72mpassvtxl8w3kaygtmmyqug6snu8gat --temporary-secret-str f9762a7e193d021f9feedf3d06e1a8121910acb3e21dd0be5aa246210e8366dc

      at src/core/charms-sdk.ts:16:11

[2025-07-28T20:31:43.214Z] Error:
  console.error
    Stderr: detected old compiler flags: recompile the ELF for additional security
    

      18 |      console.error = function (...args: any[]) {
      19 |              console.log('Error:');
    > 20 |              originalConsoleError(...args);
         |              ^
      21 |      };
      22 | }
      23 |

      at console.error (src/core/log.ts:20:3)
      at src/core/charms-sdk.ts:32:14

  console.info
    Executed successfully: ["02000000017e7eaca11100cf74fb1064e695f1505aafb1aba11f159f02cca93010aea9dea40000000000ffffffff01d08e022a010000002251202c297102388973e3a59702690f175f463f29b0f483e708f5024ac02622a321ae00000000","02000000000101c5ee8dc0fde79a76dbcea52393123565aa728394ed3177324ddea7ee15ebd4c00000000000ffffffff02e803000000000000225120f6739a9f3c1477905f63c6193a6292eb387a23d0bbd4632d0e2bc1c0d5d583a35c13f72901000000225120d9e5a20e71a69da791e84d3fba93a03795b0f61062cdf3ba36e910bdec80e2350341c585b18a6797f2f3c03652c26c5b474272b8b02ffe3ae4fb610b47ffce173317948e21fb83bb10663570f510b9d4c31c7b5e41f49783a0659484092b6178808081fd4f030063057370656c6c4d080282a36776657273696f6e04627478a2647265667380646f75747381a100a3667469636b657269475241494c2d4e46547163757272656e745f636f7369676e6572737840616437323635303733363436326237393433626465633937663962646662373639346137643730326565333238633333623531663335333063663637626264327163757272656e745f7468726573686f6c6401716170705f7075626c69635f696e70757473a183616e982018500218d418500918bd1862187e0218851846183108185618f518b0185e185f18f518671823186813187b1836183b187418d518f618e21878184f982018c218ee18da184718cd18e818841851182618f21875181c189e18ae18db185018b2189f15184b184918b51824185618dd183218d71820184e182b0f181fa166616374696f6e666465706c6f7999010418a41859184c18590d189d182d18e61318b2181e18e018d218a303182f18a11826187318c2183918a718b0181f18e918a003182518df186a0c18bd1318c61862185b0f188718fd187a185a0818c3182e18f318461845184f0018641860181f1867181a184f0118af1823186b18ee188518450918dc187917185218d2181a18e905183e0318ca18c8181d1870187518be187e185118e6187018551418ec18d5184b18b1183118bb18c8188b186e187518c518a118db0e18d00d186d09182318fe187e18360718c018b21878185a4d160118ea10189a187318870a18e8184d1881186318d11851182218f417183b18b918f818201843182c1854184318d818601822181c18a7185f18f3181918381818187818ee18f2189b18d01852188a18a3187918a01855021837184e18f718f918d618c30a1018ef18d502183a18fa18330018d21893188c189518df18a211183b1875188d185b189e0b183a185a188718ae18f2189f18860f183f18c41869181c18ab181d15183118a018da186c18e118e1183f185a1871189a18f3183e18aa18da18801875184818dd184d18301890181f1850050418cd06183c182718891819183d184a18c218fe18e2185d1828181e18c518d118db1861185618d41518ba15183e18f2186f185718d6186d18fc188c18af184918a8046820fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655bac21c0fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655b00000000"]

      at src/core/charms-sdk.ts:34:13

[2025-07-28T20:31:43.217Z] Spell created successfully: {
        "commitmentTxBytes": "0x02000000017e7eaca11100cf74fb1064e695f1505aafb1aba11f159f02cca93010aea9dea40000000000ffffffff01d08e022a010000002251202c297102388973e3a59702690f175f463f29b0f483e708f5024ac02622a321ae00000000",
        "spellTxBytes": "0x02000000000101c5ee8dc0fde79a76dbcea52393123565aa728394ed3177324ddea7ee15ebd4c00000000000ffffffff02e803000000000000225120f6739a9f3c1477905f63c6193a6292eb387a23d0bbd4632d0e2bc1c0d5d583a35c13f72901000000225120d9e5a20e71a69da791e84d3fba93a03795b0f61062cdf3ba36e910bdec80e2350341c585b18a6797f2f3c03652c26c5b474272b8b02ffe3ae4fb610b47ffce173317948e21fb83bb10663570f510b9d4c31c7b5e41f49783a0659484092b6178808081fd4f030063057370656c6c4d080282a36776657273696f6e04627478a2647265667380646f75747381a100a3667469636b657269475241494c2d4e46547163757272656e745f636f7369676e6572737840616437323635303733363436326237393433626465633937663962646662373639346137643730326565333238633333623531663335333063663637626264327163757272656e745f7468726573686f6c6401716170705f7075626c69635f696e70757473a183616e982018500218d418500918bd1862187e0218851846183108185618f518b0185e185f18f518671823186813187b1836183b187418d518f618e21878184f982018c218ee18da184718cd18e818841851182618f21875181c189e18ae18db185018b2189f15184b184918b51824185618dd183218d71820184e182b0f181fa166616374696f6e666465706c6f7999010418a41859184c18590d189d182d18e61318b2181e18e018d218a303182f18a11826187318c2183918a718b0181f18e918a003182518df186a0c18bd1318c61862185b0f188718fd187a185a0818c3182e18f318461845184f0018641860181f1867181a184f0118af1823186b18ee188518450918dc187917185218d2181a18e905183e0318ca18c8181d1870187518be187e185118e6187018551418ec18d5184b18b1183118bb18c8188b186e187518c518a118db0e18d00d186d09182318fe187e18360718c018b21878185a4d160118ea10189a187318870a18e8184d1881186318d11851182218f417183b18b918f818201843182c1854184318d818601822181c18a7185f18f3181918381818187818ee18f2189b18d01852188a18a3187918a01855021837184e18f718f918d618c30a1018ef18d502183a18fa18330018d21893188c189518df18a211183b1875188d185b189e0b183a185a188718ae18f2189f18860f183f18c41869181c18ab181d15183118a018da186c18e118e1183f185a1871189a18f3183e18aa18da18801875184818dd184d18301890181f1850050418cd06183c182718891819183d184a18c218fe18e2185d1828181e18c518d118db1861185618d41518ba15183e18f2186f185718d6186d18fc188c18af184918a8046820fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655bac21c0fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655b00000000"
}
[2025-07-28T20:31:43.217Z] Spell created: {
        "commitmentTxBytes": "0x02000000017e7eaca11100cf74fb1064e695f1505aafb1aba11f159f02cca93010aea9dea40000000000ffffffff01d08e022a010000002251202c297102388973e3a59702690f175f463f29b0f483e708f5024ac02622a321ae00000000",
        "spellTxBytes": "0x02000000000101c5ee8dc0fde79a76dbcea52393123565aa728394ed3177324ddea7ee15ebd4c00000000000ffffffff02e803000000000000225120f6739a9f3c1477905f63c6193a6292eb387a23d0bbd4632d0e2bc1c0d5d583a35c13f72901000000225120d9e5a20e71a69da791e84d3fba93a03795b0f61062cdf3ba36e910bdec80e2350341c585b18a6797f2f3c03652c26c5b474272b8b02ffe3ae4fb610b47ffce173317948e21fb83bb10663570f510b9d4c31c7b5e41f49783a0659484092b6178808081fd4f030063057370656c6c4d080282a36776657273696f6e04627478a2647265667380646f75747381a100a3667469636b657269475241494c2d4e46547163757272656e745f636f7369676e6572737840616437323635303733363436326237393433626465633937663962646662373639346137643730326565333238633333623531663335333063663637626264327163757272656e745f7468726573686f6c6401716170705f7075626c69635f696e70757473a183616e982018500218d418500918bd1862187e0218851846183108185618f518b0185e185f18f518671823186813187b1836183b187418d518f618e21878184f982018c218ee18da184718cd18e818841851182618f21875181c189e18ae18db185018b2189f15184b184918b51824185618dd183218d71820184e182b0f181fa166616374696f6e666465706c6f7999010418a41859184c18590d189d182d18e61318b2181e18e018d218a303182f18a11826187318c2183918a718b0181f18e918a003182518df186a0c18bd1318c61862185b0f188718fd187a185a0818c3182e18f318461845184f0018641860181f1867181a184f0118af1823186b18ee188518450918dc187917185218d2181a18e905183e0318ca18c8181d1870187518be187e185118e6187018551418ec18d5184b18b1183118bb18c8188b186e187518c518a118db0e18d00d186d09182318fe187e18360718c018b21878185a4d160118ea10189a187318870a18e8184d1881186318d11851182218f417183b18b918f818201843182c1854184318d818601822181c18a7185f18f3181918381818187818ee18f2189b18d01852188a18a3187918a01855021837184e18f718f918d618c30a1018ef18d502183a18fa18330018d21893188c189518df18a211183b1875188d185b189e0b183a185a188718ae18f2189f18860f183f18c41869181c18ab181d15183118a018da186c18e118e1183f185a1871189a18f3183e18aa18da18801875184818dd184d18301890181f1850050418cd06183c182718891819183d184a18c218fe18e2185d1828181e18c518d118db1861185618d41518ba15183e18f2186f185718d6186d18fc188c18af184918a8046820fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655bac21c0fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655b00000000"
}
[2025-07-28T20:31:43.217Z] Transmitting spell...
  console.info
    Sending commitment transaction: 020000000001017e7eaca11100cf74fb1064e695f1505aafb1aba11f159f02cca93010aea9dea40000000000ffffffff01d08e022a010000002251202c297102388973e3a59702690f175f463f29b0f483e708f5024ac02622a321ae014136a5d2e533a1bcc77e7453bfa98dfd7d7af206579cee7cc9fba34e45a789489077455eba75f68a532c48f1fa69cd95d2825f490269df977d2014db6b3c7ef7408100000000

      at transmitSpell (src/api/spell-operations.ts:187:10)

  console.info
    Sending spell transaction: 02000000000101c5ee8dc0fde79a76dbcea52393123565aa728394ed3177324ddea7ee15ebd4c00000000000ffffffff02e803000000000000225120f6739a9f3c1477905f63c6193a6292eb387a23d0bbd4632d0e2bc1c0d5d583a35c13f72901000000225120d9e5a20e71a69da791e84d3fba93a03795b0f61062cdf3ba36e910bdec80e2350341c585b18a6797f2f3c03652c26c5b474272b8b02ffe3ae4fb610b47ffce173317948e21fb83bb10663570f510b9d4c31c7b5e41f49783a0659484092b6178808081fd4f030063057370656c6c4d080282a36776657273696f6e04627478a2647265667380646f75747381a100a3667469636b657269475241494c2d4e46547163757272656e745f636f7369676e6572737840616437323635303733363436326237393433626465633937663962646662373639346137643730326565333238633333623531663335333063663637626264327163757272656e745f7468726573686f6c6401716170705f7075626c69635f696e70757473a183616e982018500218d418500918bd1862187e0218851846183108185618f518b0185e185f18f518671823186813187b1836183b187418d518f618e21878184f982018c218ee18da184718cd18e818841851182618f21875181c189e18ae18db185018b2189f15184b184918b51824185618dd183218d71820184e182b0f181fa166616374696f6e666465706c6f7999010418a41859184c18590d189d182d18e61318b2181e18e018d218a303182f18a11826187318c2183918a718b0181f18e918a003182518df186a0c18bd1318c61862185b0f188718fd187a185a0818c3182e18f318461845184f0018641860181f1867181a184f0118af1823186b18ee188518450918dc187917185218d2181a18e905183e0318ca18c8181d1870187518be187e185118e6187018551418ec18d5184b18b1183118bb18c8188b186e187518c518a118db0e18d00d186d09182318fe187e18360718c018b21878185a4d160118ea10189a187318870a18e8184d1881186318d11851182218f417183b18b918f818201843182c1854184318d818601822181c18a7185f18f3181918381818187818ee18f2189b18d01852188a18a3187918a01855021837184e18f718f918d618c30a1018ef18d502183a18fa18330018d21893188c189518df18a211183b1875188d185b189e0b183a185a188718ae18f2189f18860f183f18c41869181c18ab181d15183118a018da186c18e118e1183f185a1871189a18f3183e18aa18da18801875184818dd184d18301890181f1850050418cd06183c182718891819183d184a18c218fe18e2185d1828181e18c518d118db1861185618d41518ba15183e18f2186f185718d6186d18fc188c18af184918a8046820fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655bac21c0fedec31c362f3b7fd37324ffdcc17c2c1facb3a6b07ac51a5a22149cf19a655b00000000

      at transmitSpell (src/api/spell-operations.ts:194:10)

[2025-07-28T20:31:43.263Z] Spell transmitted successfully: [
  "c0d4eb15eea7de4d327731ed948372aa6535129323a5cedb769ae7fdc08deec5",
  "6477a17e83bd434717c93eb14f41fe55d6387f8b463e650473e95cec744226eb"
]
[2025-07-28T20:31:43.263Z] Deployment Result: {
  "appId": "5002d45009bd627e028546310856f5b05e5ff5672368137b363b74d5f6e2784f",
  "appVk": "c2eeda47cde8845126f2751c9eaedb50b29f154b49b52456dd32d7204e2b0f1f",
  "spellTxid": "6477a17e83bd434717c93eb14f41fe55d6387f8b463e650473e95cec744226eb"
}
 PASS  tests/simple-e2e.test.ts (51.796 s)
  simple e2e test
    âœ“ should deploy the NFT (51046 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        51.862 s
Ran all test suites.
```